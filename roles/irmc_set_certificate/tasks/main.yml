---
# tasks file for ./roles/irmc_set_certificate
- name: Convert SSL private key generated by OpenSSL from ver.3.x to ver.1.x
  ansible.builtin.replace:
    path: "{{ ssl_private_key_path }}"
    regexp: "{{ item.regexp }}"
    replace: "{{ item.replace }}"
  loop:
    - { regexp: "BEGIN PRIVATE KEY", replace: "BEGIN RSA PRIVATE KEY" }
    - { regexp: "END PRIVATE KEY", replace: "END RSA PRIVATE KEY" }
  tags: convert

- name: Set iRMC certificates
  fujitsu.primergy.irmc_certificate:
    irmc_url: "{{ inventory_hostname }}"
    irmc_username: "{{ irmc_user }}"
    irmc_password: "{{ irmc_password }}"
    validate_certs: "{{ validate_certificate }}"
    command: "set"
    private_key_path: "{{ ssl_private_key_path }}"
    ssl_cert_path: "{{ ssl_cert_path }}"
    ssl_ca_cert_path: "{{ ssl_ca_cert_path }}"
  delegate_to: localhost
  register: set_result
  tags: set

- name: Reboot iRMC
  ansible.builtin.uri:
    url: "https://{{ inventory_hostname }}/rest/v1/Oem/iRMC/Reset"
    method: POST
    headers:
      Accept: application/json
      Content type: application/json
    status_code: 202
    validate_certs: false
    user: "{{ irmc_user }}"
    password: "{{ irmc_password }}"
    force_basic_auth: true
  tags: reboot
